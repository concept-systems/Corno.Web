@using Microsoft.AspNet.Identity

@{
    Layout = "/Views/Shared/_Layout.cshtml";

    ViewBag.Index = "Index";
    ViewBag.Create = "Create";
    ViewBag.Edit = "Edit";
    ViewBag.Details = "Details";
    ViewBag.Delete = "Delete";
}

@{
    var routeUrl = Url.RouteUrl(ViewContext.RouteData.Values);
    /*var itemStyle = "";
    if ((string)ViewData["Title"] == "Overview")
    {
        itemStyle = "display:none";
    }*/

    var claimsIdentity = User.Identity as System.Security.Claims.ClaimsIdentity;

    //var userEmail = "";
    var userName = "";

    if (claimsIdentity != null)
    {
        //userEmail = claimsIdentity.Claims.First().Value;
        //userName = claimsIdentity.Claims.Last()?.Subject.Name;
    }

    userName = User.Identity.Name;
}

@(Html.Kendo().Drawer()
    .Name("drawer")
    .TemplateId("drawerTemplate")
    //.Mode("push")
    .Mini(false)
    //.Position("left")
    .AutoCollapse(true)
    /*	.Width(240)
	.Navigatable(true)
    .AutoCollapse(false)
    .SwipeToOpen(true)*/
    //.Events(ev => ev.ItemClick("onItemClick"))
    .HtmlAttributes(new { style = "display:none;" }) // Initially hidden
    .Content(@<text>
                 <div>
                     <main role="main" class="k-content">
                         @(Html.Kendo().AppBar()
                             .Name("appBar")
                             .Position(AppBarPosition.Top)
                             .PositionMode(AppBarPositionMode.Sticky)
                             .ThemeColor(AppBarThemeColor.Light)
                             .HtmlAttributes(new { style = "height: 48px" })
                             .Items(items =>
                             {
                                 items.Add().Template("<a id='menuIcon' class='k-button k-button-md k-button-rectangle k-rounded-md k-button-solid k-button-solid-base' style='border:0px; background:\\#FFFFFF;' href='\\#'><span class='k-icon k-i-menu'></span></a>").Type(AppBarItemType.ContentItem);
                                 items.Add().Template("<a href='" + Url.Action("Index", "Home", new {area = ""}) + "' class='k-button k-button-md k-button-rectangle k-rounded-md k-button-solid k-button-solid-base home-button' style='border:0px; background:\\#FFFFFF;' title='Home'><span class='k-icon k-i-home'></span></a>").Type(AppBarItemType.ContentItem);
                                 items.Add().Template("<div class='title'>" + ViewBag.BoxTitle + "</div>").Type(AppBarItemType.ContentItem);
                                 // Spacer to push the user info to the right
                                 items.Add().Type(AppBarItemType.Spacer);

                                 // User avatar, name and dropdown menu
                                 items.Add().TemplateId("appBar-user-menu-template")
                                     .Type(AppBarItemType.ContentItem);
                             }))

                         @RenderBody()
                     </main>
                 </div>
	</text>)
)

<script id="drawerTemplate" type="text/html">
    <div style="height: 100%; padding: 10px;">
        @(Html.Kendo().TreeView()
            .Name("mnuTree")
            .AutoScroll(true)
            .ExpandAll(true)
            .HtmlAttributes(new { style = "height: 100%; overflow: auto;" })
            .BindTo(User.Identity.GetUserId(), (item, value) =>
            {
                if (value.ChildNodes.Count > 0)
                    item.Enabled = false;

                if (value.RouteValues["web"]?.ToString() != "true")
                    item.Visible = false;

                // Assign icons to TreeView items using the same logic as Home index menu
                var title = value.Title;
                var iconAttr = value.Attributes.ContainsKey("icon") ? value.Attributes["icon"]?.ToString() : null;
                var nameAttr = value.Attributes.ContainsKey("name") ? value.Attributes["name"]?.ToString() : null;
                var iconClass = Corno.Web.Helpers.MenuIconHelper.GetIconClass(title, nameAttr, iconAttr);
                // TreeView sprites expect full icon CSS classes; include k-icon + specific icon
                item.SpriteCssClasses = $"k-icon {iconClass}";
            })
            .SecurityTrimming(false))
    </div>
</script>

<script id="appBar-user-menu-template" type="text/x-kendo-tmpl">
<div class="appbar-user-menu">
    <div class="user-menu-trigger" id="userMenuTrigger">
        <img src='@Url.Content("~/favicon.ico")' class="user-avatar" alt="User" />
        <span class="user-name">@userName</span>
        <span class="k-icon k-i-arrow-s"></span>
    </div>
    <div class="user-menu-dropdown" id="userMenuDropdown">
        <div class="user-menu-header">
            <img src='@Url.Content("~/favicon.ico")' class="user-avatar-large" alt="User" />
            <div class="user-info">
                <div class="user-name-large">@userName</div>
            </div>
        </div>
        <div class="user-menu-divider"></div>
        <form action="@Url.Action("LogOff", "Account", new {area=""})" method="post" class="logout-form">
            @Html.AntiForgeryToken()
            <button type="submit" class="user-menu-item logout-item">
                <span class="k-icon k-i-logout"></span>
                <span>Logout</span>
            </button>
        </form>
    </div>
</div>
</script>

@*<script id="treeview-template" type="text/x-kendo-tmpl">
        @(Html.Kendo().TreeView()
            .Name("mnuTree")
            .ExpandAll(true)
            .AutoScroll(true)
            .HtmlAttributes(new { style = "height: 100px; overflow: auto;" }) // Set height and overflow
            .BindTo(FieldConstants.Project, (item, value) =>
            {
                if (value.ChildNodes.Count > 0)
                    item.Enabled = false;

                if (item.RouteValues["web"]?.ToString() != "true")
                    item.Visible = false;
                //var message =
                //    $@"Title1 : {item?.Text}, Controller1 : {item?.ControllerName ?? string.Empty}, Action1 : {item?.ActionName}, Area1 : ";
                //message += item?.RouteValues["area"];
                //Javascript.ConsoleLog(message);
                //if (value.Attributes[FieldConstants.MiscType] != null)
                //{
                //    item.RouteValues.Add(FieldConstants.MiscType, value.Attributes[FieldConstants.MiscType]?.ToString());
                //}
            })
            .SecurityTrimming(false)
            .ToClientTemplate())
    </script>*@


<style>

    .spacer-container {
        background-color: #f3f3f3;
    }

    .appbar-container {
        height: 400px;
        overflow: auto;
    }

    #example div.configurator {
        margin: 0;
    }

    #demo-runner {
        padding: 0;
    }

    .title {
        font-size: 18px;
        margin: 0;
    }

    .social-section .k-icon {
        margin: 0 4px;
    }

    .links {
        font-size: 18px;
        margin: 0;
    }

    .k-display-flex {
        display: flex;
        width: 250px;
    }

    .page-content {
        background: white;
        padding: 25px 10px;
        margin-top: 1px;
    }

        .page-content p {
            font-size: 18px;
        }


    #name {
        font-weight: bold;
        font-size: 14px;
    }

    #email {
        font-size: 12px;
        text-decoration-line: underline;
    }

    #menuIcon {
        cursor: pointer;
    }

    .home-button {
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    .home-button:hover {
        background-color: #f5f5f5 !important;
    }

    .home-button .k-icon {
        color: #424242;
    }

    .title {
        font-size: 18px;
        font-weight: bold;
        line-height: 20px;
        /*color: #2D73F5;*/
        color: #424242;
    }

    .app-bar-link {
        font-size: 14px;
        line-height: 20px;
        color: #424242;
        cursor: pointer;
    }

    li[data-role='drawer-item'] > a {
        color: #424242;
    }

    li.k-state-selected[data-role='drawer-item'] > a {
        color: #FFFFFF;
        background: aqua;
    }

    /* User Menu Styles */
    .appbar-user-menu {
        position: relative;
        display: flex;
        align-items: center;
        height: 100%;
        z-index: 10001;
    }

    /* Ensure AppBar doesn't clip the dropdown */
    #appBar {
        overflow: visible !important;
    }

    #appBar .k-appbar-items {
        overflow: visible !important;
    }

    .user-menu-trigger {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 4px 12px;
        cursor: pointer;
        border-radius: 4px;
        transition: background-color 0.2s;
        height: 36px;
    }

    .user-menu-trigger:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }

    .user-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #e0e0e0;
    }

    .user-name {
        font-size: 14px;
        font-weight: 500;
        color: #424242;
        max-width: 150px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .user-menu-trigger .k-icon {
        font-size: 12px;
        color: #757575;
        margin-left: 4px;
        transition: transform 0.2s;
    }

    .user-menu-trigger.active .k-icon {
        transform: rotate(180deg);
    }

    .user-menu-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 8px;
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        min-width: 240px;
        z-index: 10000;
        overflow: hidden;
        display: none;
    }

    .user-menu-dropdown.show {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }

    .user-menu-header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px;
        background-color: #f5f5f5;
    }

    .user-avatar-large {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #e0e0e0;
    }

    .user-info {
        flex: 1;
        min-width: 0;
    }

    .user-name-large {
        font-size: 16px;
        font-weight: 600;
        color: #212121;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .user-menu-divider {
        height: 1px;
        background-color: #e0e0e0;
        margin: 0;
    }

    .user-menu-item {
        display: flex;
        align-items: center;
        gap: 12px;
        width: 100%;
        padding: 12px 16px;
        background: none;
        border: none;
        text-align: left;
        cursor: pointer;
        font-size: 14px;
        color: #424242;
        transition: background-color 0.2s;
    }

    .user-menu-item:hover {
        background-color: #f5f5f5;
    }

    .user-menu-item .k-icon {
        font-size: 16px;
        color: #757575;
    }

    .logout-item {
        color: #d32f2f;
    }

    .logout-item:hover {
        background-color: #ffebee;
    }

    .logout-item .k-icon {
        color: #d32f2f;
    }

    .logout-form {
        margin: 0;
        padding: 0;
    }

    /* Prevent clicks inside dropdown from closing it */
    .user-menu-dropdown * {
        pointer-events: auto;
    }

    /* Drawer TreeView leverages shared menu.css base styles; keep only minimal overrides here if needed. */
</style>

<script>
    $(document).ready(function () {
		//highlight selected Drawer item on page load
        $('a[href="@routeUrl"]').parent().addClass('k-state-selected');
		if ($(window).width() < 600) {
			$("#drawer").getKendoDrawer().hide();
		}
		resizeWidgets();

        $(window).resize(function () {
			resizeWidgets()
        });

        $("#menuIcon").click(function (e) {
			e.stopPropagation(); // Prevent document click from closing drawer immediately
			var drawerInstance = $("#drawer").data("kendoDrawer");
			var drawerContainer = drawerInstance.drawerContainer;

			if (drawerContainer.hasClass("k-drawer-expanded")) {
				drawerInstance.hide();
			} else {
				drawerInstance.show();
			};
			//resize widgets after Drawer animmation has completed
			setTimeout(resizeWidgets, 400)
		});

		// Function to close drawer
		function closeDrawer() {
			var drawerInstance = $("#drawer").data("kendoDrawer");
			if (drawerInstance) {
				var drawerContainer = drawerInstance.drawerContainer;
				if (drawerContainer && drawerContainer.hasClass("k-drawer-expanded")) {
					drawerInstance.hide();
					setTimeout(resizeWidgets, 400);
				}
			}
		}

		// Prevent clicks inside drawer from closing it
		$(document).on("click", ".k-drawer-container, .k-drawer-wrapper, .k-drawer-content, .k-drawer-item", function(e) {
			e.stopPropagation();
		});

		// Function to close user menu dropdown
		function closeUserMenu() {
			$(".user-menu-dropdown").removeClass("show").css("display", "");
			$(".user-menu-trigger").removeClass("active");
		}

		// User menu dropdown toggle
		$(document).on("click", ".user-menu-trigger", function(e) {
			e.preventDefault();
			e.stopPropagation();
			
			var menuContainer = $(this).closest(".appbar-user-menu");
			var dropdown = menuContainer.find(".user-menu-dropdown");
			var trigger = $(this);
			var isVisible = dropdown.hasClass("show");
			
			// Close all other dropdowns first
			$(".user-menu-dropdown").not(dropdown).removeClass("show").css("display", "");
			$(".user-menu-trigger").not(trigger).removeClass("active");
			
			if (isVisible) {
				// Close the dropdown
				dropdown.removeClass("show").css("display", "");
				trigger.removeClass("active");
			} else {
				// Open the dropdown
				dropdown.addClass("show").css("display", "block");
				trigger.addClass("active");
			}
			
			// Prevent the document click handler from closing it immediately
			return false;
		});

		// Prevent clicks inside dropdown from propagating
		$(document).on("click", ".user-menu-dropdown", function(e) {
			e.stopPropagation();
		});

		// Close dropdown and drawer when clicking outside
		$(document).on("click", function(e) {
			var target = $(e.target);
			
			// Handle user menu dropdown
			// Don't close if clicking on the trigger (handled by toggle handler)
			if (!target.closest(".user-menu-trigger").length) {
				// Don't close if clicking inside the dropdown
				if (!target.closest(".user-menu-dropdown").length) {
					// Close the dropdown for any other click
					closeUserMenu();
				}
			}
			
			// Handle drawer
			// Don't close if clicking on the menu icon (handled by menu icon handler)
			if (!target.closest("#menuIcon").length) {
				// Don't close if clicking inside the drawer
				if (!target.closest(".k-drawer-container, .k-drawer-wrapper, .k-drawer-content, .k-drawer-item").length) {
					// Close the drawer for any other click
					closeDrawer();
				}
			}
		});

		// Close dropdown when clicking menu icon
		$(document).on("click", "#menuIcon", function() {
			closeUserMenu();
		});

		// Close dropdown on escape key
		$(document).on("keydown", function(e) {
			if (e.key === "Escape") {
				closeUserMenu();
			}
		});
	});

    @*function onItemClick(e) {
        // Removed debug alert
        if (!e.item.hasClass("k-drawer-separator")) {
            alert("Item Clicked : " + e.item.find("a").attr("href"));
            var targetPage = e.item.find("a").attr("href");
            window.location.href = targetPage;
        }
    }*@

    function resizeWidgets() {
        var charts = $(".k-chart");
        if (charts) {
            charts.each((idx, elem) => $(elem).getKendoChart().resize(true))
        }
        var grid = $(".k-grid");
        if (grid) {
            grid.each((idx, elem) => $(elem).getKendoGrid().resize(true))
        }
    }

    @*function onNodeSelect(e) {
        var treeView = $("#treeView").data("kendoTreeView");
        var node = e.node; // Expand the clicked node's parent
        var parentNode = treeView.parent(node);
        if (parentNode.length > 0)        {
            treeView.expand(parentNode);
        }
    }*@

</script>
