@using Corno.Web.Globals
@using Corno.Web.Helpers
@using SiteMapNode = Kendo.Mvc.SiteMapNode
@{
    Layout = "~/Views/Shared/_AppLayout.cshtml";

    ViewBag.Title = "Home Page";
    ViewBag.BoxTitle = "Home";
    
    var siteMapRoot = ViewBag.SiteMapRoot as SiteMapNode;
    var rootNodes = siteMapRoot?.ChildNodes?.Where(n => n.RouteValues.ContainsKey("web") && n.RouteValues["web"]?.ToString() == "true").ToList() ?? new List<SiteMapNode>();
}

@if (!string.IsNullOrEmpty(ViewBag.ErrorMessage as string))
{
    <div id="errorAlert" class="k-alert k-alert-error k-alert-solid k-alert-border k-alert-rounded-md" style="margin: 20px; padding: 20px;">
        <div class="k-alert-content">
            <div class="k-alert-title" style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">
                <span class="k-icon k-i-warning"></span> Error
            </div>
            <div class="k-alert-message" style="margin-bottom: 15px;">
                @ViewBag.ErrorMessage
            </div>
            <div class="k-hstack k-gap-2" style="flex-wrap: wrap;">
                <button type="button" id="btnReloadPage" class="k-button k-button-md k-button-rectangle k-rounded-md k-button-solid k-button-primary">
                    <span class="k-icon k-i-reload"></span>
                    <span>Reload Page</span>
                </button>
            </div>
        </div>
    </div>
}

@if (ViewBag.ShowMigrationPrompt == true)
{
    <div id="migrationPrompt" class="migration-prompt k-alert k-alert-info k-alert-solid k-alert-border k-alert-rounded-md" style="margin: 20px; padding: 20px;">
        <div class="k-alert-content">
            <div class="k-alert-title" style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">
                Menu Migration Required
            </div>
            <div class="k-alert-message" style="margin-bottom: 15px;">
                No menus found in the database. You can migrate menus from the XML sitemap or add default login module menus.
                <br />
                <strong>Choose an option below:</strong>
            </div>
            <div class="k-hstack k-gap-2" style="flex-wrap: wrap;">
                <button type="button" id="btnMigrateMenus" class="k-button k-button-md k-button-rectangle k-rounded-md k-button-solid k-button-primary">
                    <span class="k-icon k-i-upload"></span>
                    <span>Migrate from Sitemap</span>
                </button>
                <button type="button" id="btnAddLoginMenus" class="k-button k-button-md k-button-rectangle k-rounded-md k-button-solid k-button-base">
                    <span class="k-icon k-i-plus"></span>
                    <span>Add Login Menus</span>
                </button>
                <button type="button" id="btnDismissPrompt" class="k-button k-button-md k-button-rectangle k-rounded-md k-button-flat k-button-flat-base">
                    <span>Dismiss</span>
                </button>
            </div>
            <div id="migrationStatus" style="margin-top: 15px; display: none;"></div>
        </div>
    </div>
}

<div class="">
    <div class="home-menu-toolbar mt-2">
        <div class="home-menu-search-wrapper k-textbox k-input k-input-solid k-input-md">
            <span class="k-input-prefix">
                <span class="k-icon k-i-search"></span>
            </span>
            <input id="homeMenuSearch"
                   type="text"
                   class="home-menu-search-input k-input-inner"
                   placeholder="Search menu by name or group..." 
                   autocomplete="off" />
            <button type="button"
                    id="homeMenuSearchClear"
                    class="home-menu-search-clear k-button k-button-md k-button-rectangle k-rounded-md k-button-flat k-button-flat-base"
                    title="Clear search">
                <span class="k-icon k-i-close"></span>
            </button>
        </div>
        <div class="home-menu-search-hint">
            Start typing to quickly find any menu. Matching groups and tiles will be highlighted automatically.
        </div>
    </div>

    <div class="home-menu-container k-animation-container">
    @foreach (var groupNode in rootNodes)
    {
        var menuItems = groupNode.ChildNodes?.Where(n => n.RouteValues.ContainsKey("web") && n.RouteValues["web"]?.ToString() == "true").ToList() ?? new List<SiteMapNode>();
        
        if (menuItems.Any())
        {
            <div class="menu-group-section">
                <h2 class="menu-group-title">@groupNode.Title</h2>
                <div class="menu-cards-container">
                    @foreach (var menuItem in menuItems)
                    {
                        var area = menuItem.RouteValues.ContainsKey("area") ? menuItem.RouteValues["area"]?.ToString() : "";
                        var controller = menuItem.ControllerName ?? "";
                        var action = menuItem.ActionName ?? "Index";
                        // Read MiscType from route values (added in HomeController.ConvertMenusToSiteMapAsync)
                        var miscType = menuItem.RouteValues.ContainsKey(FieldConstants.MiscType)
                            ? menuItem.RouteValues[FieldConstants.MiscType]?.ToString()
                            : menuItem.RouteValues.ContainsKey(FieldConstants.MiscType.ToLower())
                                ? menuItem.RouteValues[FieldConstants.MiscType.ToLower()]?.ToString()
                                : null;
                        var reportName = menuItem.RouteValues.ContainsKey("reportName") ? menuItem.RouteValues["reportName"]?.ToString() : "";
                        var url = string.IsNullOrEmpty(area)
                            ? Url.Action(action, controller, new { miscType, reportName })
                            : Url.Action(action, controller, new { area, miscType, reportName });

                        var iconAttr = menuItem.Attributes.ContainsKey("icon") ? menuItem.Attributes["icon"]?.ToString() : null;
                        var nameAttr = menuItem.Attributes.ContainsKey("name") ? menuItem.Attributes["name"]?.ToString() : null;
                        var iconClass = MenuIconHelper.GetIconClass(menuItem.Title, nameAttr, iconAttr);

                        <div class="menu-card-wrapper">
                            <a href="@url" class="menu-card k-card k-card-type-rich k-hstack">
                                <div class="k-card-body k-vstack k-flex-1">
                                    <div class="menu-card-header k-hstack">
                                        <span class="menu-card-icon k-avatar k-avatar-solid k-avatar-primary k-avatar-md">
                                            <span class="k-icon @iconClass"></span>
                                        </span>
                                        <h3 class="menu-card-title k-text-bold k-text-primary">@menuItem.Title</h3>
                                    </div>
                                </div>
                                <div class="menu-card-arrow k-hstack k-align-items-center k-justify-content-center k-px-2">
                                    <span class="k-icon k-i-arrow-right"></span>
                                </div>
                            </a>
                        </div>
                    }
                </div>
            </div>
        }
    }

        <div id="homeMenuNoResults" class="home-menu-no-results" style="display: none;">
            <div class="home-menu-no-results-icon">
                <span class="k-icon k-i-search"></span>
            </div>
            <div class="home-menu-no-results-text">
                No menus match your search. Try a different keyword or clear the search filter.
            </div>
        </div>
    </div> <!-- /.home-menu-container -->
</div> <!-- /.home-menu-page -->
<style>
    .home-menu-page {
        max-width: 1400px;
        margin: 0 auto;
        padding: 16px 20px 24px;
    }

    .home-menu-toolbar {
        position: sticky;
        top: 56px; /* below Kendo AppBar */
        z-index: 5;
        background: #f5f5f5;
        padding: 12px 12px 14px;
        margin: -16px -20px 12px;
        border-bottom: 1px solid #e0e0e0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .home-menu-search-wrapper {
        display: flex;
        align-items: center;
        gap: 6px;
        max-width: 560px;
        width: 100%;
        background-color: #ffffff;
        border-radius: 999px;
        padding-left: 12px;
        padding-right: 4px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
        margin: 0 auto;
    }

    .home-menu-search-wrapper .k-icon {
        color: #757575;
        font-size: 16px;
    }

    .home-menu-search-input {
        border: none !important;
        box-shadow: none !important;
        outline: none !important;
        width: 100%;
        background: transparent;
        font-size: 14px;
        padding: 8px 4px;
    }

    .home-menu-search-input::placeholder {
        color: #9e9e9e;
    }

    .home-menu-search-clear {
        border: none;
        box-shadow: none;
        min-width: 32px;
        width: 32px;
        height: 32px;
        padding: 0;
        display: none;
        align-items: center;
        justify-content: center;
    }

    .home-menu-search-clear .k-icon {
        font-size: 14px;
    }

    .home-menu-search-hint {
        margin-top: 6px;
        font-size: 12px;
        color: #757575;
        text-align: center;
    }

    .home-menu-container {
        padding-top: 12px;
    }

    .menu-group-section {
        margin-bottom: 40px;
    }

    .menu-group-title {
        font-size: 24px;
        font-weight: 600;
        color: #424242;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e0e0e0;
    }

    .menu-cards-container {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
    }

    .menu-card-wrapper {
        height: 100%;
    }

    .menu-card {
        display: flex;
        flex-direction: column;
        height: 100%;
        min-height: 140px;
        background: #ffffff;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 20px;
        text-decoration: none;
        color: inherit;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        position: relative;
        overflow: hidden;
    }

    .menu-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        border-color: #1565c0;
        text-decoration: none;
        color: inherit;
    }

    .menu-card-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 56px;
        height: 56px;
        background: linear-gradient(135deg, #1565c0 0%, #1976d2 100%);
        border-radius: 12px;
        margin-bottom: 16px;
    }

    .menu-card-icon .k-icon {
        font-size: 28px;
        color: #ffffff;
    }

    .menu-card:hover .menu-card-icon {
        background: linear-gradient(135deg, #0d47a1 0%, #1565c0 100%);
    }

    .menu-card-content {
        flex: 1;
    }

    .menu-card-title {
        font-size: 18px;
        font-weight: 600;
        color: #212121;
        margin: 0 0 8px 0;
    }


    .menu-card-arrow {
        position: absolute;
        top: 20px;
        right: 20px;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .menu-card-arrow .k-icon {
        font-size: 20px;
        color: #1565c0;
    }

    .menu-card:hover .menu-card-arrow {
        opacity: 1;
    }

    .home-menu-no-results {
        margin-top: 32px;
        padding: 32px 24px;
        border-radius: 8px;
        border: 1px dashed #cfcfcf;
        background: #fafafa;
        text-align: center;
        color: #757575;
    }

    .home-menu-no-results-icon {
        margin-bottom: 8px;
    }

    .home-menu-no-results-icon .k-icon {
        font-size: 28px;
        color: #bdbdbd;
    }

    .home-menu-no-results-text {
        font-size: 14px;
    }

    /* Responsive design - Multiple columns for optimal screen space usage */
    @@media (min-width: 1600px) {
        .menu-cards-container {
            grid-template-columns: repeat(5, 1fr);
        }
    }

    @@media (min-width: 1200px) and (max-width: 1599px) {
        .menu-cards-container {
            grid-template-columns: repeat(4, 1fr);
        }
    }

    @@media (min-width: 900px) and (max-width: 1199px) {
        .menu-cards-container {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    @@media (min-width: 600px) and (max-width: 899px) {
        .menu-cards-container {
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
    }

    @@media (max-width: 768px) {
        .home-menu-page {
            padding: 12px 12px 20px;
        }

        .home-menu-toolbar {
            top: 48px;
            padding: 10px 10px 12px;
            margin: -12px -12px 10px;
        }

        .home-menu-search-wrapper {
            max-width: 100%;
        }

        .menu-cards-container {
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .menu-group-title {
            font-size: 20px;
        }

        .menu-card {
            min-height: 120px;
            padding: 16px;
        }

        .menu-card-icon {
            width: 48px;
            height: 48px;
        }

        .menu-card-icon .k-icon {
            font-size: 24px;
        }

        .menu-card-title {
            font-size: 16px;
        }
    }

    @@media (max-width: 480px) {
        .menu-cards-container {
            grid-template-columns: 1fr;
        }
    }
</style>

    <script>
        (function ($) {
            function debounce(fn, delay) {
                var timeout;
                return function () {
                    var context = this;
                    var args = arguments;
                    clearTimeout(timeout);
                    timeout = setTimeout(function () {
                        fn.apply(context, args);
                    }, delay);
                };
            }

            function applyHomeMenuFilter() {
                var query = $.trim($("#homeMenuSearch").val() || "").toLowerCase();
                var hasQuery = query.length > 0;
                var anyVisible = false;

                // Toggle clear button
                if (hasQuery) {
                    $("#homeMenuSearchClear").css("display", "flex");
                } else {
                    $("#homeMenuSearchClear").hide();
                }

                $(".menu-group-section").each(function () {
                    var $group = $(this);
                    var groupTitle = ($group.find(".menu-group-title").first().text() || "").toLowerCase();
                    var groupMatches = hasQuery && groupTitle.indexOf(query) !== -1;
                    var visibleCardsInGroup = 0;

                    $group.find(".menu-card-wrapper").each(function () {
                        var $cardWrapper = $(this);
                        var titleText = ($cardWrapper.find(".menu-card-title").first().text() || "").toLowerCase();
                        var cardMatches = !hasQuery || titleText.indexOf(query) !== -1 || groupMatches;

                        if (cardMatches) {
                            $cardWrapper.show();
                            visibleCardsInGroup++;
                        } else {
                            $cardWrapper.hide();
                        }
                    });

                    if (visibleCardsInGroup > 0) {
                        $group.show();
                        anyVisible = true;
                    } else {
                        $group.hide();
                    }
                });

                // No results message
                if (!anyVisible && hasQuery) {
                    $("#homeMenuNoResults").show();
                } else {
                    $("#homeMenuNoResults").hide();
                }
            }

            $(document).ready(function () {
                var debouncedFilter = debounce(applyHomeMenuFilter, 150);

                $("#homeMenuSearch").on("input", debouncedFilter);

                $("#homeMenuSearchClear").on("click", function () {
                    $("#homeMenuSearch").val("");
                    applyHomeMenuFilter();
                    $("#homeMenuSearch").focus();
                });

                // Initial layout state
                applyHomeMenuFilter();
            });

            // Error alert handlers
            $(document).ready(function() {
                $("#btnReloadPage").on("click", function() {
                    window.location.reload();
                });
            });

            // Migration prompt handlers
            $(document).ready(function() {
                $("#btnMigrateMenus").on("click", function() {
                    var $btn = $(this);
                    var $status = $("#migrationStatus");
                    
                    $btn.prop("disabled", true).html('<span class="k-icon k-i-loading"></span> Migrating...');
                    $status.html("").show();
                    
                    $.ajax({
                        url: '@Url.Action("MigrateFromXml", "Menu", new { area = "Admin" })',
                        type: "POST",
                        data: { projectName: "@ViewBag.ProjectName" },
                        success: function(response) {
                            if (response.success) {
                                $status.html('<div class="k-alert k-alert-success" style="padding: 10px; margin-top: 10px;">' +
                                    '<strong>Success!</strong> ' + response.message + 
                                    '<br/>Created: ' + response.createdMenus + ', Updated: ' + response.updatedMenus +
                                    '</div>');
                                
                                // Reload page after 2 seconds to show menus
                                setTimeout(function() {
                                    window.location.reload();
                                }, 2000);
                            } else {
                                $status.html('<div class="k-alert k-alert-error" style="padding: 10px; margin-top: 10px;">' +
                                    '<strong>Error:</strong> ' + (response.message || "Migration failed") +
                                    '</div>');
                                $btn.prop("disabled", false).html('<span class="k-icon k-i-upload"></span> Migrate from Sitemap');
                            }
                        },
                        error: function(xhr, status, error) {
                            $status.html('<div class="k-alert k-alert-error" style="padding: 10px; margin-top: 10px;">' +
                                '<strong>Error:</strong> ' + (xhr.responseJSON?.message || error || "An error occurred during migration") +
                                '</div>');
                            $btn.prop("disabled", false).html('<span class="k-icon k-i-refresh"></span> Migrate Menus from XML');
                        }
                    });
                });
                
                // Handle "Add Login Menus" button
                $("#btnAddLoginMenus").on("click", function() {
                    var $btn = $(this);
                    var $status = $("#migrationStatus");
                    
                    $btn.prop("disabled", true).html('<span class="k-icon k-i-loading"></span> Adding Login Menus...');
                    $status.html("").show();
                    
                    $.ajax({
                        url: '@Url.Action("CreateDefaultMenus", "Menu", new { area = "Admin" })',
                        type: "POST",
                        success: function(response) {
                            if (response.success) {
                                $status.html('<div class="k-alert k-alert-success" style="padding: 10px; margin-top: 10px;">' +
                                    '<strong>Success!</strong> ' + response.message + 
                                    '<br/>Created: ' + response.createdMenus + ', Updated: ' + (response.updatedMenus || 0) +
                                    (response.skippedMenus > 0 ? ', Skipped: ' + response.skippedMenus : '') +
                                    '</div>');
                                
                                // Reload page after 2 seconds to show menus
                                setTimeout(function() {
                                    window.location.reload();
                                }, 2000);
                            } else {
                                $status.html('<div class="k-alert k-alert-error" style="padding: 10px; margin-top: 10px;">' +
                                    '<strong>Error:</strong> ' + (response.message || "Failed to add login menus") +
                                    (response.errors && response.errors.length > 0 ? '<br/>' + response.errors.join('<br/>') : '') +
                                    '</div>');
                                $btn.prop("disabled", false).html('<span class="k-icon k-i-plus"></span> Add Login Menus');
                            }
                        },
                        error: function(xhr, status, error) {
                            $status.html('<div class="k-alert k-alert-error" style="padding: 10px; margin-top: 10px;">' +
                                '<strong>Error:</strong> ' + (xhr.responseJSON?.message || error || "An error occurred while adding login menus") +
                                '</div>');
                            $btn.prop("disabled", false).html('<span class="k-icon k-i-plus"></span> Add Login Menus');
                        }
                    });
                });
                
                $("#btnDismissPrompt").on("click", function() {
                    $.ajax({
                        url: '@Url.Action("DismissMigrationPrompt", "Home")',
                        type: "POST",
                        success: function() {
                            $("#migrationPrompt").fadeOut();
                        }
                    });
                });
            });
        })(jQuery);
    </script>
