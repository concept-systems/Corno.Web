@using Corno.Web.Areas.BoardStore.Models
@using Corno.Web.Globals
@using Kendo.Mvc.UI
@model Corno.Web.Areas.BoardStore.Models.Movement

@using Corno.Web.Helper

@{
    Layout = "~/Views/Shared/_AppLayout.cshtml";
}

@{
    ViewBag.BoxTitle = "Movement";
}

@{
    ViewBag.Index = "Index";
    ViewBag.Create = "Create";
    ViewBag.Edit = "Edit";
    ViewBag.Details = "Details";
    ViewBag.Delete = "Delete";
}

@{
    Page.Title = "Movement";

    ViewBag.MainHeader = "Movement";
    ViewBag.MainMenu = "BoardStore";
    ViewBag.Controller = "Movement";
    ViewBag.CurrentLink = "Movement";
}
<div class="grid-container-full-height">
    @(Html.Kendo().Grid<Movement>()
        .Name("grid")
        .ApplyIndexSettings() // 👈 Apply index settings (full height, responsive)
        .Events(events => events.ApplyCommonEvents())
        .Columns(columns =>
            {
                // Serial Number Column
                columns.Template(@<text>#: ++rowNumber #</text>)
                     .Title("Serial</br> No")
                     .HeaderHtmlAttributes(new { @class = "k-text-center" })
                     .HtmlAttributes(new { style = "text-align: center" })
                     .Width(15);
                columns.Bound(m => m.CreatedDate)
                    .HtmlAttributes(new { style = "text-align: center" })
                    .HeaderHtmlAttributes(new { @class = "k-text-center !k-justify-content-center" })
                    .Format("{0:dd/MM/yyyy}")
                    .Title("Date").Width(30);
                columns.Bound(m => m.Id)
                    .HeaderHtmlAttributes(new { @class = "k-text-center !k-justify-content-center" })
                    .Width(20)
                    .Title("Transaction Id")
                    .HtmlAttributes(new { style = "text-align: center" });
                columns.Bound(m => m.RequestCode)
                    .HtmlAttributes(new { style = "text-align: center" })
                    .HeaderHtmlAttributes(new { @class = "k-text-center !k-justify-content-center" })
                    .Width(20)
                    .Title("Request</br>Code");
                columns.Bound(m => m.RequestNo)
                    .HtmlAttributes(new { style = "text-align: center" })
                    .HeaderHtmlAttributes(new { @class = "k-text-center !k-justify-content-center" })
                    .Width(20)
                    .Title("Request</br>No");
                columns.Bound(m => m.ItemId)
                    .HeaderHtmlAttributes(new { @class = "k-text-center !k-justify-content-center" })
                    .Width(30)
                    .Title("Item");

                columns.Bound(m => m.FromLocationId)
                    .HtmlAttributes(new { style = "text-align: center" })
                    .HeaderHtmlAttributes(new { @class = "k-text-center !k-justify-content-center" })
                    .Width(20)
                    .Title("From </br>Location");
                columns.Bound(m => m.ToLocationId)
                    .HtmlAttributes(new { style = "text-align: center" })
                    .HeaderHtmlAttributes(new { @class = "k-text-center !k-justify-content-center" })
                    .Width(20)
                    .Title("To</br>Location");
                columns.Bound(m => m.Status).Width(20).Title("Status")
                    .HtmlAttributes(new { style = "text-align: center" })
                    .ClientTemplate(
                        "<span class='badge' style='background-color: " +
                        "# if (Status == \"Active\") { #" +
                        "red" +
                        "# } else if (Status == \"Completed\") { #" +
                        "green" +
                        "# } else { #" +
                        "transparent" +
                        "# } #" +
                        "; color: " +
                        "# if (Status == \"Active\" || Status == \"Completed\") { #" +
                        "white" +
                        "# } else { #" +
                        "black" +
                        "# } #" +
                        "; text-align: center; display: inline-block;'>" +
                        "#= Status #</span>"
                    )
                    .HtmlAttributes(new { @class = "k-text-center !k-justify-content-center" })
                    .HeaderHtmlAttributes(new { @class = "k-text-center !k-justify-content-center" })
                    .Width(20);
                columns.Command(command =>
                {
                    command.Custom("View").Text(" ").IconClass("k-icon k-i-preview k-i-eye")
                        .HtmlAttributes(new { @class = "k-grid-view k-text-center !k-justify-content-center" })
                        .Click("onViewClick");
                    // Show only if Status is "Active";
                    command.Custom("Delete").Text(" ").IconClass("k-icon k-i-delete  k-text-error")
                        .HtmlAttributes(new { @class = "k-grid-delete k-text-center !k-justify-content-center" })
                        .Click("onDeleteClick");

                })
                    .HeaderHtmlAttributes(new { @class = "k-text-center !k-justify-content-center" })
                    .HtmlAttributes(new { @class = "k-text-center !k-justify-content-center" })
                    .Width(20)
                    .Title("Actions"); // Add a class to identify the command column;
            })
        .Events(events => {
            events.ApplyCommonEvents();
            events.DataBound("onDataBound");
        })
        .DataSource(dataSource => dataSource
            .Ajax()
            .PageSize(15)
            .ServerOperation(true)
            .Read(read => read.Action("GetIndexViewModels", "Movement"))
            .Sort(s => s.Add(FieldConstants.Id).Descending())
            .Model(model => model.Id(FieldConstants.Id))
        ))
</div>

<script type="text/javascript">
      function onViewClick(e) {
         e.preventDefault();
         var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
         var id = dataItem.Id; // Assuming 'Id' is the field name
          window.location.href = '@Url.Action("View", "Movement")' + '?id=' + id;
      }


    function onDeleteClick(e) {
        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
        var id = dataItem.Id; // Assuming 'Id' is the field name
        bootbox.confirm({
            message: "Are you sure you want to delete this item?",
            centerVertical: true,
            buttons: {
                confirm: {
                    label: 'Yes',
                    className: 'btn-danger'
                },
                cancel: {
                    label: 'No',
                    className: 'btn-secondary'
                }
            },
            callback: function (result) {
                if (result) {
                    // User confirmed, proceed with deletion
                    $.ajax({
                        url: '@Url.Action("DeleteMovement", "Movement")', // Replace with your actual controller and action
                        method: 'POST',
                        data: { id: id }, // Pass the ID of the record to delete
                        success: function (result) {
                            if (result.success) {
                                bootbox.alert({
                                    message: '<i class="fa fa-check-circle" style="color: green;"></i> ' + result.message,
                                    centerVertical: true
                                });
                                // Optionally, refresh the grid or page
                                location.reload();
                            } else {
                                bootbox.alert({
                                    message: '<i class="fa fa-exclamation-circle" style="color: red;"></i> ' + result.message,
                                    centerVertical: true
                                });
                            }
                        },
                        error: function (xhr, ajaxOptions, thrownError) {
                            var errorMessage = xhr.responseJSON && xhr.responseJSON.message ?
                                xhr.responseJSON.message : "An error occurred while deleting. Please try again.";

                            bootbox.alert({
                                message: errorMessage,
                                centerVertical: true
                            });
                        }
                    });
                }
            }
        });
    }

    var rowNumber = 0;
    function onDataBound(e) {
        rowNumber = 0; // Reset the row number counter
        var rows = this.items();
        for (var i = 0; i < rows.length; i++) {
            rowNumber++;
            // Insert the serial number into the first cell
            $(rows[i]).find("td:first").html(rowNumber);
        }
    }

</script>
