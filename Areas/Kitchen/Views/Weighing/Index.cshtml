@using Corno.Web.Areas.Kitchen.Dto.Carton
@using Corno.Web.Globals
@using Kendo.Mvc.UI

@{
    Layout = "~/Views/Shared/_AppLayout.cshtml";
    ViewBag.BoxTitle = "Weighing";
}


@using Corno.Web.Helper

<div class="grid-container-full-height">
    @(Html.Kendo().Grid<CartonIndexDto>()
        .Name("grid")
        .ApplyIndexSettings() // 👈 Apply index settings (full height, responsive)
        .AddExportToolBar(enableExcel: true, enablePdf: true, enableSearch: true, customToolbar: toolbar =>
        {
            toolbar.Custom()
                .Text("<span class='k-icon k-i-plus'></span> Add New")
                .HtmlAttributes(new { @class = "k-grid-add-new k-button-add-new-outlined", style = "float: right;", onclick = $"window.location.href='{Url.Action("Create", "Weighing")}'; return false;" });
        })
        .Events(events => events.ApplyCommonEvents())
    .Columns(columns =>
    {
        //columns.Select()
        //    .HtmlAttributes(new { style = "text-align: center" });
        columns.Bound(m => m.WarehouseOrderNo)
            .ClientTemplate("<a href='" + Url.Action("View", "Plan") + "?warehouseOrderNo=#=WarehouseOrderNo#' class='text-primary text-decoration-underline'>#=WarehouseOrderNo#</a>")
            .HeaderHtmlAttributes(new { @class = "k-text-center !k-justify-content-center" })
            //.HtmlAttributes(new { style = "text-align: center" })
            .Title("Warehouse Order");
        columns.Bound(m => m.CartonNo)
            .ClientTemplate("<a href='" + Url.Action("View", "Carton") + "?id=#=Id#' class='text-primary text-decoration-underline'>#=CartonNo#</a>")
            .HeaderHtmlAttributes(new { @class = "k-text-center !k-justify-content-center" })
            //.HtmlAttributes(new { style = "text-align: center" })
            .Title("Carton No");
        columns.Bound(m => m.PackingDate)
            //.HtmlAttributes(new { style = "text-align: center" })
            .HeaderHtmlAttributes(new { @class = "k-text-center !k-justify-content-center" })
            .Format("{0:dd/MM/yyyy}")
            .Title("Packing Date");
        columns.Bound(m => m.SoNo)
            .HeaderHtmlAttributes(new { @class = "k-text-center !k-justify-content-center" })
            //.HtmlAttributes(new { style = "text-align: center" })
            .Title("So No");
        columns.Bound(m => m.CartonBarcode)
            //.HtmlAttributes(new { style = "text-align: center" })
            .HeaderHtmlAttributes(new { @class = "k-text-center !k-justify-content-center" })
            .Title("Carton Barcode");
        columns.Bound(m => m.Status)
            .HtmlAttributes(new { style = "text-align: center" })
            .ClientTemplate(
                "<span class='badge' style='background-color: " +
                "# if (Status == \"Active\") { #" +
                "red" +
                "# } else if (Status == \"Packed\") { #" +
                "Green" +
                "# } else if (Status == \"Rack Out\") { #" +
                "Blue" +
                "# } else if (Status == \"Rack In\") { #" +
                "Orange" +
                "# } else if (Status == \"Pallet In\") { #" +
                "Purple" +
                "# } else if (Status == \"Unload\") { #" +
                "Maroon" +
                "# } else { #" +
                "transparent" +
                "# } #" +
                "; color: " +
                "# if (Status == \"Active\" || Status == \"Packed\" ||  Status == \"Rack Out\" || Status == \"Rack In\" || Status == \"Pallet In\" || Status == \"Unload\") { #" +
                "white" +
                "# } else { #" +
                "black" +
                "# } #" +
                "; text-align: center; display: inline-block;'>" +
                "#= Status #</span>"
            )
            .HtmlAttributes(new { @class = "k-text-center !k-justify-content-center" })
            .HeaderHtmlAttributes(new { @class = "k-text-center !k-justify-content-center" });
        columns.Command(command =>
        {
            //command.Custom("View").Text(" ").IconClass("k-icon k-i-preview k-i-eye")
            //    .HtmlAttributes(new { @class = "k-grid-view k-text-center !k-justify-content-center" })
            //    .Click("onViewClick");
            command.Custom("Delete").Text("")
                .Text("<i class='k-icon k-i-delete k-text-error'></i>")
                .HtmlAttributes(new { @class = "k-grid-delete" })
                .Click("onDeleteClick");
        })
        .HeaderHtmlAttributes(new { @class = "k-text-center !k-justify-content-center" })
            .HtmlAttributes(new { style = "text-align: center" })
        .Title("Actions"); // Add a class to identify the command column;

    })
    .DataSource(dataSource => dataSource
        .Ajax()
        .PageSize(9)
        .Read(read => read.Action("GetIndexViewModels", "Weighing"))
        .Group(group => { group.Add(g => g.WarehouseOrderNo); })
        .Sort(sort => sort.Add(FieldConstants.Id).Descending())
        .Model(model => model.Id(FieldConstants.Id))
    ))
</div>

<script type="text/javascript">

      function onViewClick(e) {
         e.preventDefault();
         var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
         var id = dataItem.Id; // Assuming 'Id' is the field name
         window.location.href = '@Url.Action("View", "Weighing")' + '?id=' + id;
      }

       function onDeleteClick(e) {
 var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
     var id = dataItem.Id; // Assuming 'Id' is the field name
     bootbox.confirm({
         message: "Are you sure you want to delete this item?",
         centerVertical: true,
             buttons: {
                 confirm: {
                     label: 'Yes',
                     className: 'btn-danger'
                 },
                 cancel: {
                     label: 'No',
                     className: 'btn-secondary'
                 }
             },
         callback: function (result) {
             if (result) {
                 // User confirmed, proceed with deletion
                 $.ajax({
                     url: '@Url.Action("DeleteCarton", "Carton")', // Replace with your actual controller and action
                     method: 'POST',
                     data: { id: id }, // Pass the ID of the record to delete
                     success: function (result) {
                         if (result.success) {
                             bootbox.alert({
                                 message: '<i class="fa fa-check-circle" style="color: green;"></i> ' + result.message,
                                 centerVertical: true
                             });
                             // Optionally, refresh the grid or page
                             location.reload();
                         } else {
                             bootbox.alert({
                                 message: '<i class="fa fa-exclamation-circle" style="color: red;"></i> ' + result.message,
                                 centerVertical: true
                             });
                         }
                     },
                     error: function (xhr, ajaxOptions, thrownError) {
                         var errorMessage = xhr.responseJSON && xhr.responseJSON.message ?
                             xhr.responseJSON.message : "An error occurred while deleting. Please try again.";

                         bootbox.alert({
                             message: errorMessage,
                             centerVertical: true
                         });
                     }
                 });
             }
         }
      });
  }
         @*function onDeleteClick(e) {
            e.preventDefault();
            var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
            window.location.href = '@Url.Action("DeleteCarton", "Weighing")' + '/' + dataItem.Id;
         }*@
</script>