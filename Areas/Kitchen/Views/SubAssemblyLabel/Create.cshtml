@using Corno.Web.Helper
@using Kendo.Mvc.UI
@model Corno.Web.Areas.Kitchen.Dto.Label.SubAssemblyCrudDto

@{
    Layout = "~/Views/Shared/_LayoutBase.cshtml";
}

@{
    ViewBag.BoxTitle = "Create New Sub Assembly";
    ViewBag.SubmitAction = "Create";
}
@section sectionBaseHeader
{
    <div class="k-card-actions k-card-actions-horizontal k-card-actions-end">
        @(Html.Kendo().Button()
            .Name("btnList")
            .Content("List")
            .ApplyStandardSettingsWithType(ButtonType.Info, "arrow-left", ComponentSize.Medium)
            .Events(e => e.Click("onBack")))
    </div>
}
@(Html.Kendo().TileLayout()
    .Name("tileLayout")
    .Columns(2)
    .RowsHeight("90px")
    .ColumnsWidth("100%")
    .Containers(c => {
         c.Add()
             .BodyTemplateId("template-items-Info")
             .ColSpan(1)
             .RowSpan(4);
         c.Add()
             .BodyTemplateId("template-barcode")
             .ColSpan(1)
             .RowSpan(4);
    })
    .Reorderable(true)
    .Resizable(true))

<script id="template-barcode" type="text/x-kendo-template">
            @Html.AntiForgeryToken()
            <div class="row required">
                @Html.LabelFor(m => m.Barcode1, "Barcode 1 :", new { @class = "col-3 col-form-label" })
                <div class="col-9">
                     @(Html.Kendo().TextBoxFor(m => m.Barcode1)
                         //.Events(e => e.Change("onChangeBarcode1"))
                         .HtmlAttributes(new { @class = "w-100" }).ToClientTemplate())
                </div>
            </div>
            <div class="row required">
                @Html.LabelFor(m => m.Barcode2, "Barcode 2 :", new { @class = "col-3 col-form-label" })
                <div class="col-9">
                    @(Html.Kendo().TextBoxFor(m => m.Barcode2)
                        //.Events(e => e.Change("onChangeBarcode2"))
                        .HtmlAttributes(new { @class = "w-100" }).ToClientTemplate())
                </div>
            </div>
            <div class="row required">
                 @Html.LabelFor(m => m.Barcode3, "Barcode 3 :", new { @class = "col-3 col-form-label" })
                 <div class="col-9 ">
                     @(Html.Kendo().TextBoxFor(m => m.Barcode3)
                         //.Events(e => e.Change("onChangeBarcode3"))
                         .HtmlAttributes(new { @class = "w-100" }).ToClientTemplate())
                 </div>
             </div>
            <div class="row required">
                 @Html.LabelFor(m => m.Barcode4, "Barcode 4 :", new { @class = "col-3 col-form-label" })
                 <div class="col-9 ">
                    @(Html.Kendo().TextBoxFor(m => m.Barcode4)
                        //.Events(e => e.Change("onChangeBarcode4"))
                        .HtmlAttributes(new { @class = "w-100" }).ToClientTemplate())
                 </div>
             </div>
             <div class="row required">
                  <div class="col-6 offset-3">
                    @(Html.Kendo().CheckBoxFor(m => m.CheckboxField)
                        .Checked(true)
                        .Name("directSubAssembly")
                        .Label("Direct Sub-Assembly")
                        .HtmlAttributes(new { tabindex = "0" })
                        .ToClientTemplate())
                  </div>
            </div>
            <div class="k-card-actions k-card-actions-horizontal k-card-actions-end form-group">
                @(Html.Kendo().Button()
                    .Name("preview")
                    .Content("Preview")
                    .ApplyStandardSettingsWithType(ButtonType.Info, "preview", ComponentSize.Medium)
                    .Events(e => e.Click("onPreview"))
                    .ToClientTemplate())
                @(Html.Kendo().Button()
                    .Name("print")
                    .Content("Print")
                    .ApplyStandardSettingsWithType(ButtonType.Primary, "print", ComponentSize.Medium)
                    .Events(e => e.Click("onPrint"))
                    .ToClientTemplate())
            </div>
</script>
<script id="template-items-Info" type="text/x-kendo-template">
          <div class="col-12">
          <!-- Placeholder for the partial view -->
          <div id="partialViewContainer" style="height: 100%"></div>
    </div>
</script>

<script type="text/javascript">

    $(document).ready(function () {
        $("#form").kendoValidator({
        });
    });

    setTimeout(function () {
        document.getElementById("Barcode1").focus();
        $('#Barcode1').val(''); //txtID is textbox ID
    }, 100); // Delay to ensure focus is set correctly

    $(document).ready(function () {
        // Handle Enter key press in Barcode1
        var isChecked = localStorage.getItem("directSubAssembly") === "true";
        $("#Barcode1").on("keypress", function (e) {
            if (e.which === 13) { // Enter key pressed
                e.preventDefault();

                if ($("#directSubAssembly").is(":checked")) {
                    // If checkbox is checked, trigger print
                    $("#print").click();
                } else {
                    // If checkbox is unchecked, move focus to Barcode2
                    $("#Barcode2").data("kendoTextBox").focus();
                }
            }

        });

        // Handle Enter key press in Barcode2
        $("#Barcode2").on("keypress", function (e) {
            if (e.which === 13) { // Enter key pressed
                e.preventDefault();

                // Move focus to Barcode3
                $("#Barcode3").data("kendoTextBox").focus();
            }
        });

        // Handle Enter key press in Barcode3
        $("#Barcode3").on("keypress", function (e) {
            if (e.which === 13) { // Enter key pressed
                e.preventDefault();

                // Move focus to Barcode4
                $("#Barcode4").data("kendoTextBox").focus();
            }
        });

        // Handle Enter key press in Barcode4
        $("#Barcode4").on("keypress", function (e) {
            if (e.which === 13) { // Enter key pressed
                e.preventDefault();

                $("#print").click();
            }
        });
    });

    function onSaveClick() {
        var cmbSerialNo = $("#SerialNo").data("kendoMultiColumnComboBox");
        cmbSerialNo.dataSource.read();
    };

    function onBack() {
        window.location.href = '@Url.Action("Index", "SubAssemblyLabel", new { area = "Kitchen" })';
    }

    // Build FormData from current form, including all barcode fields explicitly
    function buildSubAssemblyFormData() {
        const form = $("form")[0];
        const formData = new FormData(form);

        // Ensure all barcode values are present in FormData
        formData.set("Barcode1", $("#Barcode1").val());
        formData.set("Barcode2", $("#Barcode2").val());
        formData.set("Barcode3", $("#Barcode3").val());
        formData.set("Barcode4", $("#Barcode4").val());

        return formData;
    }

    function onPrint(e) {
        e.preventDefault();
        const formData = buildSubAssemblyFormData();
        fetchAndPrint('/SubAssemblyLabel/Print', formData, function () {
            console.log('SubAssembly print success.');

            // Clear barcode fields after successful print
            $("#Barcode1").val("");
            $("#Barcode2").val("");
            $("#Barcode3").val("");
            $("#Barcode4").val("");

            // Reset focus to first barcode for next scan
            var barcode1 = $("#Barcode1").data("kendoTextBox");
            if (barcode1) {
                barcode1.focus();
            } else {
                $("#Barcode1").focus();
            }
        });
    }

    function onPreview(e) {
        e.preventDefault();
        const formData = buildSubAssemblyFormData();
        fetchAndPreviewPdf('/SubAssemblyLabel/Preview', formData, "Sub Assembly Label");
    }
</script>
