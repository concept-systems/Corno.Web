@using Corno.Web.Areas.Kitchen.Dto.Carton
@using Corno.Web.Globals
@using Corno.Web.Helper
@using Kendo.Mvc.UI

@{
    var controllerName = ViewBag.ControllerName as string ?? "NonWeighingPacking";
    var viewAction = ViewBag.ViewAction as string ?? "View";
    var dataSourceAction = ViewBag.DataSourceAction as string ?? "GetIndexViewDto";
    var showAddNewButton = ViewBag.ShowAddNewButton as bool? ?? true;
    var showCarcassButton = ViewBag.ShowCarcassButton as bool? ?? false;
    var showNonWeighingButton = ViewBag.ShowNonWeighingButton as bool? ?? false;
    var commandColumnPosition = ViewBag.CommandColumnPosition as string ?? "start"; // "start" or "end"
}

@if (showCarcassButton || showNonWeighingButton)
{
    <div style="margin-bottom: 10px;">
        @if (showCarcassButton)
        {
            @(Html.Kendo().Button()
                .Name("btnCreateCarcass")
                .Content("Carcass")
                .ApplyStandardSettingsWithType(ButtonType.Primary, "plus", ComponentSize.Medium)
                .Events(e => e.Click("onCreateCarcassClick"))
                .HtmlAttributes(new { style = "margin-right: 10px;" }))
        }
        @if (showNonWeighingButton)
        {
            @(Html.Kendo().Button()
                .Name("btnCreateNonWeighing")
                .Content("Non Weighing Packing")
                .ApplyStandardSettingsWithType(ButtonType.Primary, "plus", ComponentSize.Medium)
                .Events(e => e.Click("onCreateNonWeighingClick"))
                .HtmlAttributes(new { style = "margin-right: 10px;" }))
        }
    </div>
}

<div class="grid-container-full-height">
    @(Html.Kendo().Grid<CartonIndexDto>()
        .Name("grid")
        .ApplyIndexSettings()
        .AddExportToolBar(enableExcel: true, enablePdf: true, enableSearch: true, customToolbar: showAddNewButton ? toolbar =>
        {
            toolbar.Custom()
                .Text("<span class='k-icon k-i-plus'></span> Add New")
                .HtmlAttributes(new { @class = "k-grid-add-new k-button-add-new-outlined", style = "float: right;", onclick = $"window.location.href='{Url.Action("Create", controllerName)}'; return false;" });
        } : null)
        .Events(events => events.ApplyCommonEvents())
        .Columns(columns =>
        {
            if (commandColumnPosition == "start")
            {
                columns.AddCommandColumns(new List<GridCommandConfig>
                {
                    new GridCommandConfig { Name = "View", Text = "", IconClass = "k-icon k-i-preview k-i-eye", ClickHandler = "onViewClick" },
                });
            }
            columns.Bound(m => m.WarehouseOrderNo).Align(TextAlign.Left).Title("Warehouse Order")
                .ClientTemplate("<a href='" + Url.Action("View", "Plan", new { area = "Kitchen" }) + "?warehouseOrderNo=#=WarehouseOrderNo#' class='text-primary text-decoration-underline'>#=WarehouseOrderNo#</a>");
            columns.Bound(m => m.CartonNo).Title("Carton<br/>No")
                .ClientTemplate("<a href='" + Url.Action(viewAction, controllerName, new { area = "Kitchen" }) + "?id=#=Id#' class='text-primary text-decoration-underline'>#=CartonNo#</a>");
            columns.Bound(m => m.PackingDate).Format("{0:dd/MM/yyyy hh:mm tt}");
            columns.Bound(m => m.SoNo);
            columns.Bound(m => m.CartonBarcode).Align(TextAlign.Left);
            columns.AddStatusColumn();
            if (commandColumnPosition == "end")
            {
                columns.AddCommandColumns(new List<GridCommandConfig>
                {
                    new GridCommandConfig { Name = "View", Text = "", IconClass = "k-icon k-i-preview k-i-eye", ClickHandler = "onViewClick" },
                });
            }
        })
        .DataSource(dataSource => dataSource
            .ApplyCommonDataSourceSettings(dataSourceAction, controllerName, "Kitchen")
            .Sort(s => s.Add(FieldConstants.Id).Descending())
            .Model(model => model.Id(FieldConstants.Id))
        ))
</div>

<script type="text/javascript">
    @if (showCarcassButton)
    {
        <text>
        function onCreateCarcassClick(e) {
            e.preventDefault();
            window.location.href = '@Url.Action("CreateCarcass", "Carton", new { area = "Kitchen" })';
        }
        </text>
    }

    @if (showNonWeighingButton)
    {
        <text>
        function onCreateNonWeighingClick(e) {
            e.preventDefault();
            window.location.href = '@Url.Action("CreateNonWeighingPacking", "Carton", new { area = "Kitchen" })';
        }
        </text>
    }

    function onViewClick(e) {
        e.preventDefault();
        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
        var id = dataItem.Id;
        window.location.href = '@Url.Action(viewAction, controllerName, new { area = "Kitchen" })' + '?id=' + id;
    }

    function onDeleteClick(e) {
        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
        var id = dataItem.Id;
        bootbox.confirm({
            message: "Are you sure you want to delete this item?",
            centerVertical: true,
            buttons: {
                confirm: {
                    label: 'Yes',
                    className: 'btn-danger'
                },
                cancel: {
                    label: 'No',
                    className: 'btn-secondary'
                }
            },
            callback: function (result) {
                if (result) {
                    $.ajax({
                        url: '@Url.Action("DeleteCarton", controllerName, new { area = "Kitchen" })',
                        method: 'POST',
                        data: { id: id },
                        success: function (result) {
                            if (result.success) {
                                bootbox.alert({
                                    message: '<i class="fa fa-check-circle" style="color: green;"></i> ' + result.message,
                                    centerVertical: true
                                });
                                var grid = $("#grid").data("kendoGrid");
                                if (grid) {
                                    grid.dataSource.read();
                                }
                            } else {
                                bootbox.alert({
                                    message: '<i class="fa fa-exclamation-circle" style="color: red;"></i> ' + result.message,
                                    centerVertical: true
                                });
                            }
                        },
                        error: function (xhr, ajaxOptions, thrownError) {
                            var errorMessage = xhr.responseJSON && xhr.responseJSON.message ?
                                xhr.responseJSON.message : "An error occurred while deleting. Please try again.";
                            bootbox.alert({
                                message: errorMessage,
                                centerVertical: true
                            });
                        }
                    });
                }
            }
        });
    }

    function sendData() {
    }
</script>

