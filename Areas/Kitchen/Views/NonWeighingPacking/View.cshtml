@using Corno.Web.Helper
@using Kendo.Mvc.UI
@model Corno.Web.Areas.Kitchen.Dto.Carton.CartonViewDto

@{
    Layout = "~/Views/Shared/_Layout.cshtml";

    ViewBag.BoxTitle = "Non Weighing View";
    ViewBag.SubmitButtonText = "Print";
}

<!-- container templates -->
<script id="template-partial-view" type="text/x-kendo-template">
    <!-- Placeholder for the partial view -->
            <div id="partialViewContainer" style="height: 100%"></div>
</script>
<script id="template-header" type="text/x-kendo-template">
   <table class="k-table k-table-auto table table-bordered">
    <tr>
        <td>
            Due Date :
        </td>
        <td>
            @(Model.DueDate.HasValue ? Model.DueDate.Value.ToString("MM/dd/yyyy") : "N/A")
        </td>
    </tr>
     <tr>
         <td>
             Warehouse Order No :
         </td>
         <td>
              @Html.DisplayFor(m => m.WarehouseOrderNo)
         </td>
     </tr>
     <tr>
        <td>
            Lot No :
        </td>
        <td>
            @Html.DisplayFor(m => m.LotNo)
        </td>
     </tr>
     @*<tr>
         <td>
             Print Quantity :
         </td>
         <td>
             @Html.DisplayFor(m => m.PrintQuantity)
         </td>
     </tr>*@
</table>
</script>
<script id="template-racking-detail">
     @(Html.Kendo().Grid(Model?.CartonRackingDetailDtos)
         .Name("rackingDetails")
         .ApplyCommonSettings() // 👈 Apply shared settings
         //.Events(events => events.ApplyCommonEvents())
         .Columns(columns =>
         {
             columns.Bound(m => m.ScanDate).Format("{0:dd/MM/yyyy hh:mm tt}");
             columns.Bound(m => m.PalletNo);
             columns.Bound(m => m.RackNo);
             //columns.AddStatusColumn();
         })
         .DataSource(dataSource => dataSource
             .Ajax()
             .ServerOperation(false))
         .ToClientTemplate())
</script>
<div class="k-card-header">
    <div class="row">
        <div class="col-6">
            <h5>
                <span class="k-icon k-i-plus k-icon k-text-success"></span>
                @ViewBag.BoxTitle
            </h5>
        </div>
        <div class="col-6 k-card-actions k-card-actions-horizontal k-card-actions-end">
            @(Html.Kendo().Button()
                .Name("DeleteButton")
                .Content("Delete")
                .ApplyStandardSettingsWithType(ButtonType.Delete, "trash", ComponentSize.Medium)
                .Events(e => e.Click("onDeleteClick"))
                .HtmlAttributes(new { id = "deleteButton", @class = "delete-button" }))
            @(Html.Kendo().Button()
                .Name("print")
                .Content("Print")
                .ApplyStandardSettingsWithType(ButtonType.Primary, "print", ComponentSize.Medium)
                .Events(e => e.Click("onPrintLabel")))
            @(Html.Kendo().Button()
                .Name("btnList")
                .Content("Back")
                .ApplyStandardSettingsWithType(ButtonType.Info, "arrow-left", ComponentSize.Medium)
                .Events(e => e.Click("onBack")))
            @(Html.Kendo().Button()
                .Name("BackToList")
                .Content("List")
                .ApplyStandardSettingsWithType(ButtonType.Info, "list", ComponentSize.Medium)
                .Events(e => e.Click("onBackToList")))
        </div>
    </div>
</div>

@(Html.Kendo().TileLayout()
    .Name("tileLayout")
    .Columns(4)
    .RowsHeight("100px")
    .ColumnsWidth("25%")
    .Containers(c => {
             c.Add()
                 .BodyTemplateId("template-partial-view")
                 .Header(h => h.Text("Label"))
                 .ColSpan(2)
                 .RowSpan(5);
             c.Add()
                 .BodyTemplateId("template-header")
                 .Header(h => h.Text("Header Info"))
                 .ColSpan(2)
                 .RowSpan(2);
             c.Add()
                 .BodyTemplateId("template-racking-detail")
                 .Header(h => h.Text("Item Info"))
                 .ColSpan(2)
                 .RowSpan(3);
    })
    .Reorderable(true)
    .Resizable(true))
@(Html.Kendo().Grid(Model?.CartonDetailsDtos)
    .Name("cartonDetails")
    .ApplyCommonSettings() // 👈 Apply shared settings
    .Events(events => events.ApplyCommonEvents())
    .Columns(columns =>
    {
        columns.Bound(m => m.WarehousePosition).Title("Warehouse<br/>Position");
        columns.Bound(m => m.Position);
        columns.Bound(m => m.AssemblyCode);
        columns.Bound(m => m.CarcassCode);
        columns.Bound(m => m.Quantity);
        columns.Bound(m => m.OrderQuantity);
    })
    .DataSource(dataSource => dataSource
        .Ajax().ServerOperation(false)))
<script>
    $(document).ready(function () {
        LoadPartialView()
    });

    function LoadPartialView(toPrinter) {
        $.ajax({
            url: '/NonWeighingPacking/LoadPartialView', // Replace with your actual controller and action
            method: 'GET',
            data: { 'partialViewName': 'Partials/ReportViewer_New' },
            success: function (partialHtml) {
                // Load HTML content into the element
                $('#partialViewContainer').html(partialHtml, function () {
                    // This code will execute after the HTML content has been loaded
                    console.log("HTML content loaded successfully");

                });
                // Delay the execution of the next statement by a short duration
                setTimeout(function () {
                    // This code will execute after a short delay
                    console.log("Timeout HTML content loaded successfully");
                    if ('@Model.PrintToPrinter' === 'True' || toPrinter === true) {
                        printToPrinter();
                    }
                }, 1500); // Adjust the delay duration as needed
            },
            error: function () {
                console.error('Failed to load the partial view.');
            }
        });

    }

    function onDeleteClick(e) {
            e.preventDefault(); // Prevent default behavior
        var id = @Model.Id; // Replace with your logic to get the dynamic ID
        bootbox.confirm("Are you sure you want to delete this carton?", function (result) {
            if (result) {
              $.ajax({
                url: '@Url.Action("DeleteCarton", "NonWeighingPacking")', // Replace with your actual controller and action
                type: 'POST',
                data: { id: id }, // Pass the required ID to the server
                success: function (result) {
                    if (result.success) {
                        @*bootbox.alert({
                            message: '<i class="fa fa-check-circle" style="color: green;"></i> ' + result.message,
                            centerVertical: true
                        });*@
                        window.location.href = '@Url.Action("Index", "NonWeighingPacking", new {area="Kitchen"})';
                    } else {
                        bootbox.alert({
                            message: '<i class="fa fa-exclamation-circle" style="color: red;"></i> ' + result.message,
                            centerVertical: true
                        });
                    }
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    var errorMessage = xhr.responseJSON && xhr.responseJSON.message ?
                        xhr.responseJSON.message : "An error occurred while deleting. Please try again.";
                    bootbox.alert({
                        message: errorMessage,
                        centerVertical: true
                    });
                }
            });
            }
        });

        }

    function onBackToList() {
        window.location.href = '@Url.Action("Index", "NonWeighingPacking", new { area = "Kitchen" })';
    }

    function onBack() {
        // Try to use referrer if available and from same origin
        var referrer = document.referrer;
        if (referrer && referrer.indexOf(window.location.origin) === 0) {
            var referrerPath = new URL(referrer).pathname;
            if (referrerPath && referrerPath !== window.location.pathname) {
                window.location.href = referrer;
                return;
            }
        }
        // Fallback to Plan/Index
        window.location.href = '@Url.Action("Index", "Plan", new { area = "Kitchen" })';
    }

    function onPrintLabel() {
        printToPrinter();
    }

    function sendData() {
    }
</script>