@using Corno.Web.Areas.Kitchen.Dto.Carton
@using Corno.Web.Globals
@using Corno.Web.Helper
@using Kendo.Mvc.UI

@{
    Layout = "~/Views/Shared/_AppLayout.cshtml";
    ViewBag.BoxTitle = "Non Weighing Packing";
}

<div class="grid-container-full-height">
    @(Html.Kendo().Grid<CartonIndexDto>()
        .Name("grid")
        .ApplyIndexSettings() // 👈 Apply index settings (full height, responsive)
        .AddExportToolBar(enableExcel: true, enablePdf: true, enableSearch: true, customToolbar: toolbar =>
        {
            toolbar.Custom()
                .Text("<span class='k-icon k-i-plus'></span> Add New")
                .HtmlAttributes(new { @class = "k-grid-add-new k-button-add-new-outlined", style = "float: right;", onclick = $"window.location.href='{Url.Action("Create", "NonWeighingPacking")}'; return false;" });
        })
        .Events(events => events.ApplyCommonEvents())
        .Columns(columns =>
        {
            columns.AddCommandColumns(new List<GridCommandConfig>
            {
                //new GridCommandConfig { Name = "Delete", Text = "<i class='k-icon k-i-delete k-text-error'></i>", IconClass = "fa fa-trash", ClickHandler = "onDeleteClick" },
                new GridCommandConfig { Name = "View", Text = "", IconClass = "k-icon k-i-preview k-i-eye", ClickHandler = "onViewClick" },
            });
            columns.Bound(m => m.WarehouseOrderNo).Align(TextAlign.Left).Title("Warehouse Order")
                .ClientTemplate("<a href='" + Url.Action("View", "Plan") + "?warehouseOrderNo=#=WarehouseOrderNo#' class='text-primary text-decoration-underline'>#=WarehouseOrderNo#</a>");;
            columns.Bound(m => m.CartonNo).Title("Carton<br/>No")
                .ClientTemplate("<a href='" + Url.Action("View", "NonWeighingPacking") + "?id=#=Id#' class='text-primary text-decoration-underline'>#=CartonNo#</a>");;
            columns.Bound(m => m.PackingDate).Format("{0:dd/MM/yyyy hh:mm tt}");
            columns.Bound(m => m.SoNo);
            columns.Bound(m => m.CartonBarcode).Align(TextAlign.Left);
            columns.AddStatusColumn();
        })
        .DataSource(dataSource => dataSource
            .ApplyCommonDataSourceSettings("GetIndexViewDto", "NonWeighingPacking", "Kitchen")
            //.Group(group => { group.AddDescending(g => g.WarehouseOrderNo); })
            .Sort(s => s.Add(FieldConstants.Id).Descending())
            .Model(model => model.Id(FieldConstants.Id))
        ))
</div>

<script type="text/javascript">
      function onViewClick(e) {
         e.preventDefault();
         var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
         var id = dataItem.Id; // Assuming 'Id' is the field name
         window.location.href = '@Url.Action("View", "NonWeighingPacking")' + '?id=' + id;
      }

         @*function onDeleteClick(e) {
            e.preventDefault();
            var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
            window.location.href = '@Url.Action("DeleteCarton", "Carton")' + '/' + dataItem.Id;
    }*@

     function onDeleteClick(e) {
     var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
         var id = dataItem.Id; // Assuming 'Id' is the field name
         bootbox.confirm({
             message: "Are you sure you want to delete this item?",
             centerVertical: true,
                 buttons: {
                     confirm: {
                         label: 'Yes',
                         className: 'btn-danger'
                     },
                     cancel: {
                         label: 'No',
                         className: 'btn-secondary'
                     }
                 },
             callback: function (result) {
                 if (result) {
                     // User confirmed, proceed with deletion
                     $.ajax({
                         url: '@Url.Action("DeleteCarton", "NonWeighingPacking")', // Replace with your actual controller and action
                         method: 'POST',
                         data: { id: id }, // Pass the ID of the record to delete
                         success: function (result) {
                             if (result.success) {
                                 bootbox.alert({
                                     message: '<i class="fa fa-check-circle" style="color: green;"></i> ' + result.message,
                                     centerVertical: true
                                 });
                             } else {
                                 bootbox.alert({
                                     message: '<i class="fa fa-exclamation-circle" style="color: red;"></i> ' + result.message,
                                     centerVertical: true
                                 });
                             }
                         },
                         error: function (xhr, ajaxOptions, thrownError) {
                             var errorMessage = xhr.responseJSON && xhr.responseJSON.message ?
                                 xhr.responseJSON.message : "An error occurred while deleting. Please try again.";

                             bootbox.alert({
                                 message: errorMessage,
                                 centerVertical: true
                             });
                         }
                     });
                 }
             }
          });
    }

    function sendData() {
    }
</script>