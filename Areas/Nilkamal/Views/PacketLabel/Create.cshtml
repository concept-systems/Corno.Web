@using Corno.Web.Globals
@using Corno.Web.Helper
@using Kendo.Mvc.UI
@model Corno.Web.Areas.Nilkamal.Dto.PacketLabel.PacketLabelCrudDto

@{
    Layout = "~/Views/Shared/_LayoutBase.cshtml";
}

@{
    ViewBag.BoxTitle = "Create New Packet Label";
    ViewBag.SubmitAction = "Create";
}

@{
    ViewBag.MainMenu = "Transaction";
    ViewBag.MainHeader = "Packet Label";
    ViewBag.CurrentSitemap = "Packet Label";
    ViewBag.Title = "Packet Label";
    ViewBag.Area = "Nilkamal";
    ViewBag.Controller = "PacketLabel";
}

@section sectionBaseFooter
{
    <div class="k-actions k-actions-horizontal k-actions-end">
        @*@(Html.Kendo().Button()
            .Name("btnBack")
            .Content("Back")
            .ApplyStandardSettingsWithType(ButtonType.Info, "arrow-60-left", ComponentSize.Medium)
            .HtmlAttributes(new { onclick = $"window.location.href='{Url.Action(ViewBag.Index, ViewBag.Controller, new { area = ViewBag.Area, miscType = ViewBag.MiscType })}'; return false;" }))*@
        @(Html.Kendo().Button()
            .Name("btnList")
            .Content("Back")
            .ApplyStandardSettingsWithType(ButtonType.Info, "arrow-left", ComponentSize.Medium)
            .Events(e => e.Click("onBack")))
        @(Html.Kendo().Button()
            .Name("preview")
            .Content("Preview")
            .ApplyStandardSettingsWithType(ButtonType.Info, "preview", ComponentSize.Medium)
            .Events(e => e.Click("onPreview")))
        @(Html.Kendo().Button()
            .Name("print")
            .Content("Print")
            .ApplyStandardSettingsWithType(ButtonType.Primary, "print", ComponentSize.Medium)
            .Events(e => e.Click("onPrint")))
    </div>
}

@(Html.Kendo().TileLayout()
    .Name("tileLayout")
    .Columns(2)
    .RowsHeight("100%")
    .ColumnsWidth("100%")
    .Containers(c => {
         c.Add()
             .BodyTemplateId("partial-view")
             .Header(h => h.Text("Header Info"))
             .ColSpan(1)
             .RowSpan(4);
         c.Add()
             .BodyTemplateId("template-items-Info")
             .Header(h => h.Text("Packets Info"))
             .ColSpan(1)
             .RowSpan(4);
    })
    .Reorderable(true)
    .Resizable(true))

<script id="partial-view" type="text/x-kendo-template">
    <div class="col-12">
          <!-- Placeholder for the partial view -->
          @*<div id="partialViewContainer" style="height: 100%"></div>*@
    </div>
</script>
<script id="template-items-Info" type="text/x-kendo-template">
  <div class=" k-content">
         @*@Html.AntiForgeryToken()
         @Html.ValidationSummary(false, "", new { @class = "text-danger" })*@
         <table class="table k-table k-table-alt-row w-100 partlabel-table">
            <tbody>
                <tr>
                    <td>Production Order :</td>
                    <td>
                        @(Html.Kendo().TextBoxFor(m => m.ProductionOrderNo)
                            .HtmlAttributes(new
                            {
                                required = "required",
                                @class = "w-100"
                            }).ToClientTemplate())
                    </td>
                </tr>
                <tr>
                    <td>Product :</td>
                    <td>
                        @(Html.Kendo().MultiColumnComboBoxFor(m => m.ProductId)
                            //.Value(Model.Position)
                            .DataTextField(FieldConstants.Name)
                            .DataValueField(FieldConstants.Id)
                            .HtmlAttributes(new { required = "required", @class = "w-100", data_multicolumn_filter = "true" })
                            .Filter(FilterType.Contains)
                            .Placeholder("Select ...")
                            .Suggest(true)
                            .Columns(columns =>
                            {
                                columns.Add().Field(FieldConstants.Id);
                                columns.Add().Field(FieldConstants.Code).Width("200px");
                                columns.Add().Field(FieldConstants.Name).Width("200px");
                            })
                            .DataSource(dataSource => dataSource
                                .Read(read => { read.Action("GetProducts", "PacketLabel").Data("getProductsParameters"); })
                                .ServerFiltering(true)
                            )
                            .AutoBind(false)
                            .CascadeFrom(FieldConstants.ProductionOrderNo).ToClientTemplate())
                    </td>
                </tr>
                <tr>
                <td>Packet :</td>
                <td>
                    @(Html.Kendo().MultiColumnComboBoxFor(m => m.PackingTypeId)
                        //.Value(Model.Position)
                        .DataTextField(FieldConstants.Name)
                        .DataValueField(FieldConstants.Id)
                        .HtmlAttributes(new { required = "required", @class = "w-100", data_multicolumn_filter = "true" })
                        .Filter(FilterType.Contains)
                        .Placeholder("Select ...")
                        .Suggest(true)
                        .Events(e => e.Select("OnItemSelect"))
                        .Columns(columns =>
                        {
                            columns.Add().Field(FieldConstants.Id).Width("100px");
                            columns.Add().Field(FieldConstants.Code).Width("200px");
                            columns.Add().Field(FieldConstants.Name).Width("200px");
                        })
                        .DataSource(dataSource => dataSource
                            .Read(read => { read.Action("GetPackets", "PacketLabel").Data("getPacketsParameters"); })
                            .ServerFiltering(true)
                        )
                        .AutoBind(false)
                        .CascadeFrom(FieldConstants.ProductId).ToClientTemplate())
                </td>
            </tr>
                <tr>
                    <td>Quantity :</td>
                    <td>
                        @(Html.Kendo().NumericTextBoxFor(m => m.Quantity)
                            .Decimals(0)
                            .Min(0)
                            .Format("n0")
                            .HtmlAttributes(new { required = "required", @class = "form-control w-100" }).ToClientTemplate())
                    </td>
                </tr>
                <tr>
                <td>Product Code :</td>
                <td id="tdProductCode"></td>
                </tr>
                <tr>
                <td>Product Name :</td>
                <td id="tdProductName"></td>
                </tr>
                <tr>
                    <td>Packet Code :</td>
                    <td id="tdPacketCode">
                    </td>
                </tr>
                <tr>
                    <td>Plan Quantity :</td>
                    <td id="tdOrderQuantity"></td>
                </tr>
                <tr>
                    <td>Pending Quantity :</td>
                    <td id="tdPrintQuantity"></td>
                </tr>
            </tbody>
        </table>
</div>
</script>

<style>
    /* PacketLabel specific responsive table styles */
    .partlabel-table {
        width: 100%;
        table-layout: auto;
    }

        .partlabel-table td {
            padding: 8px;
            word-wrap: break-word;
        }

            .partlabel-table td:first-child {
                font-weight: 600;
                white-space: nowrap;
                min-width: 120px;
            }

    /* Responsive buttons */
    .partlabel-actions {
        flex-wrap: wrap;
        gap: 8px;
    }

        .partlabel-actions .k-button {
            flex: 1 1 auto;
            min-width: 120px;
        }

    /* Responsive breakpoints */
    @@media (max-width: 992px) {
        .partlabel-table td:first-child {
            min-width: 100px;
        }
    }

    @@media (max-width: 768px) {
        .partlabel-table {
            font-size: 0.9em;
        }

            .partlabel-table td {
                padding: 6px 4px;
                display: block;
                width: 100%;
                border-bottom: 1px solid #e5e5e5;
            }

                .partlabel-table td:first-child {
                    font-weight: 700;
                    background: #f8f9fa;
                    padding-top: 10px;
                    padding-bottom: 4px;
                    border-bottom: 2px solid #dee2e6;
                }

                .partlabel-table td:last-child {
                    padding-bottom: 10px;
                }

            .partlabel-table tr {
                display: block;
                margin-bottom: 10px;
                border: 1px solid #e5e5e5;
                border-radius: 4px;
                padding: 0;
            }

            .partlabel-table tbody {
                display: block;
            }

        .partlabel-actions {
            flex-direction: column;
        }

            .partlabel-actions .k-button {
                width: 100%;
                min-width: unset;
            }
    }

    @@media (max-width: 576px) {
        .partlabel-table {
            font-size: 0.85em;
        }

            .partlabel-table td {
                padding: 5px 3px;
            }
    }
</style>

<script>
    // 🔁 Reusable helper to build FormData
    function buildFormData() {
        const formData = new FormData();
        formData.append("ProductionOrderNo", $("#ProductionOrderNo").val());
        formData.append("ProductId", $("#ProductId").val());
        formData.append("PackingTypeId", $("#PackingTypeId").val());
        formData.append("Quantity", $("#Quantity").val());

        return formData;
    }

    function onPrint(e) {
        e.preventDefault();
        const formData = buildFormData();
        fetchAndPrint('/PacketLabel/Print', formData, onPrintSuccess);
    }

    function onPreview(e) {
        e.preventDefault();
        const formData = buildFormData();
        fetchAndPreviewPdf('/PacketLabel/Preview', formData, "Packet Label");
    }

    function onPrintSuccess() {
        console.log('print success.');

        // Reload the MultiColumnComboBox
        const positionComboBox = $("#Position").data("kendoMultiColumnComboBox");
        if (positionComboBox) {
            positionComboBox.dataSource.read(); // Reload data
            positionComboBox.value("");         // Clear selection
        }

        // Clear NumericTextBox
        $("#Quantity").data("kendoNumericTextBox").value(null);

        // Clear display fields
        $("#tdItemCode").html("");
        $("#tdItemName").html("");
        $("#tdPosition").html("");
        $("#tdOrderQuantity").html("");
        $("#tdPrintQuantity").html("");
    }

    
    function OnItemSelect(e) {
        var packingCombo = e.sender;
        var selectedItem = packingCombo.dataItem(e.item.index());

        var productionOrderNo = $("#ProductionOrderNo").val();
        var productId = $("#ProductId").data("kendoMultiColumnComboBox").value();
        var packingTypeId = selectedItem.Id; // from selection
        var quantity = $("#Quantity").data("kendoNumericTextBox").value();

        var data = {
            ProductionOrderNo: productionOrderNo,
            ProductId: productId,
            PackingTypeId: packingTypeId,
            Quantity: quantity
        };

        fetch('@Url.Action("GetProductDetails", "PacketLabel")', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json', // tell server it's JSON
                'Accept': 'application/json'
            },
            body: JSON.stringify(data) // convert object to JSON
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok ' + response.statusText);
            }
            return response.json();
        })
        .then(result => {
            $("#tdProductCode").text(result.ProductCode);
            $("#tdProductName").text(result.ProductName);
            $("#tdPacketCode").text(result.PackingTypeName);
            $("#tdOrderQuantity").text(result.OrderQuantity);
            $("#tdPrintQuantity").text(result.PrintQuantity);
        })
        .catch(error => {
            console.error('Fetch error:', error);
        });
    }

    function getProductsParameters() {
        // This function adds productionOrderNo to the request
        // The filter is preserved by the helper script's parameterMap override
        return {
            productionOrderNo: $('#ProductionOrderNo').val()
        };
    }

    function getPacketsParameters() {
        // This function adds productionOrderNo to the request
        // The filter is preserved by the helper script's parameterMap override
        return {
            productionOrderNo: $("#ProductionOrderNo").val(),
            productId: $("#ProductId").data("kendoMultiColumnComboBox").value()
        };
    }

    function onBack() {
        // Try to use referrer if available and from same origin
        var referrer = document.referrer;
        if (referrer && referrer.indexOf(window.location.origin) === 0) {
            var referrerPath = new URL(referrer).pathname;
            if (referrerPath && referrerPath !== window.location.pathname) {
                window.location.href = referrer;
                return;
            }
        }
        // Fallback to Index
        window.location.href = '/Nilkamal/PacketLabel/Index';
    }
</script>