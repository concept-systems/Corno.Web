@using Corno.Web.Globals
@using Corno.Web.Helper
@using Kendo.Mvc.UI
@model Corno.Web.Areas.DemoProject.Dtos.LabelCrudDto

@{
    Layout = "~/Views/Shared/_LayoutBase.cshtml";
}

@{
    ViewBag.BoxTitle = "Create New Product Label";
    ViewBag.SubmitAction = "Create";
}

@{
    ViewBag.MainMenu = "DemoProject";
    ViewBag.MainHeader = "Product Label";
    ViewBag.CurrentSitemap = "Product Label";
    ViewBag.Title = "Product Label";
    ViewBag.Area = "DemoProject";
    ViewBag.Controller = "ProductLabel";
}

@section sectionBaseHeader
{
    <div class="k-card-actions k-actions-horizontal k-actions-end">
        @Html.Partial("Buttons/_BackButton")
        @Html.Partial("Buttons/_PreviewButton")
        @Html.Partial("Buttons/_PrintButton")
    </div>
}

@Html.Partial(@"~\Areas\DemoProject\Views\ProductLabel\_ProductLabel.cshtml", Model)

<script>
    // 🔁 Reusable helper to build FormData
    function buildFormData() {
        const formData = new FormData();
        formData.append("ProductId", $("#ProductId").val());
        formData.append("PackingTypeId", $("#PackingTypeId").val());
        formData.append("LabelFormatId", $("#LabelFormatId").val());
        formData.append("ManufacturingDate", $("#ManufacturingDate").val());
        formData.append("ExpiryDate", $("#ExpiryDate").val());
        formData.append("Quantity", $("#Quantity").val());

        return formData;
    }

    // Fetch PDF and load it into the side-by-side preview panel iframe.
    // Optionally trigger a callback (e.g., to print).
    function fetchPdfToPreviewPanel(url, formData, onLoaded) {
        fetch(url, {
            method: 'POST',
            body: formData
        })
            .then(async response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch PDF');
                }

                const contentType = response.headers.get('Content-Type');
                if (contentType && contentType.includes('application/json')) {
                    const errorData = await response.json();
                    throw new Error(errorData.Message || 'Unknown error occurred');
                }

                const blob = await response.blob();
                const pdfUrl = URL.createObjectURL(blob);

                const iframe = document.getElementById('productLabelPreviewFrame');
                if (iframe) {
                    iframe.src = pdfUrl;
                }

                if (typeof onLoaded === 'function') {
                    onLoaded();
                }
            })
            .catch(error => {
                if (typeof showErrorMessage === 'function') {
                    showErrorMessage(error.message);
                } else {
                    console.error(error.message);
                }
            });
    }

    function onPrint(e) {
        e.preventDefault();
        const formData = buildFormData();
        fetchAndPrint('/DemoProject/ProductLabel/Print', formData, onPrintSuccess);
    }

    @*function onPrint(e) {
        e.preventDefault();
        const formData = buildFormData();

        // Load PDF into preview panel and then print the iframe
        fetchPdfToPreviewPanel('/DemoProject/ProductLabel/Print', formData, function () {
            if (typeof printIFramePdf === 'function') {
                printIFramePdf('productLabelPreviewFrame');
            }
            onPrintSuccess();
        });
    }*@

    function onPreview(e) {
        e.preventDefault();
        const formData = buildFormData();

        // Only load PDF into preview panel (no print)
        fetchPdfToPreviewPanel('/DemoProject/ProductLabel/Preview', formData);
    }

    function onPrintSuccess() {
        console.log('print success.');

        // Clear form fields
        const productComboBox = $("#ProductId").data("kendoMultiColumnComboBox");
        if (productComboBox) {
            productComboBox.value("");
        }

        const packingTypeComboBox = $("#PackingTypeId").data("kendoMultiColumnComboBox");
        if (packingTypeComboBox) {
            packingTypeComboBox.value("");
        }

        const labelFormatComboBox = $("#LabelFormatId").data("kendoMultiColumnComboBox");
        if (labelFormatComboBox) {
            labelFormatComboBox.value("");
        }

        $("#ManufacturingDate").data("kendoDatePicker").value(null);
        $("#ExpiryDate").data("kendoDatePicker").value(null);
        
        // Quantity is now NumericTextBox, not TextBox
        const quantityNumericBox = $("#Quantity").data("kendoNumericTextBox");
        if (quantityNumericBox) {
            quantityNumericBox.value(null);
        }
    }
</script>

