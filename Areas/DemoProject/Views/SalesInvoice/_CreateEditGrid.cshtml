@model Corno.Web.Areas.DemoProject.Dtos.SalesInvoiceDto
@using Kendo.Mvc.UI

<div class="form-group required row">
    @Html.Label("Barcode :", new { @class = "col-4 col-form-label" })
    <div class="col-8">
        @(Html.Kendo().TextBox()
        .Name("Barcode")
        .HtmlAttributes(new
        {
            @class = "w-100",
            placeholder = "Scan barcode here..."
        }))
    </div>
</div>
<hr />
<div class="form-group row">
    <div class="col-12">
        @(Html.Kendo().Grid(Model.Details)
                 .Name("grid")
                 .Columns(columns =>
                 {
                     columns.Bound(m => m.ProductId)
                        .ClientTemplate("#= ProductName #" + "<input type='hidden' name='Details[#= index(data)#].ProductId' value='#= ProductId #' />")
                        .HtmlAttributes(new { style = "text-align: left" })
                        .HeaderHtmlAttributes(new { @class = "k-text-center !k-justify-content-center" })
                        .Title("Product");

                    columns.Bound(m => m.Mrp)
                        .ClientTemplate("#= Mrp #" + "<input type='hidden' name='Details[#= index(data)#].Mrp' value='#= Mrp #' />")
                        .HtmlAttributes(new { style = "text-align: right" })
                        .HeaderHtmlAttributes(new { @class = "k-text-center !k-justify-content-center" })
                        .FooterHtmlAttributes(new { style = "text-align: right" })
                        .ClientFooterTemplate("Total : #= kendo.toString(sum, 'n2') #");

                    // Show NetWeight with PackingTypeName separated by space
                    // Also include hidden inputs for NetWeight, PackingTypeId, PackingTypeName, and Quantity
                    columns.Bound(m => m.NetWeight)
                         .Title("Weight")
                         .ClientTemplate(
                             "#= NetWeight # #= PackingTypeName #" +
                             "<input type='hidden' name='Details[#= index(data)#].NetWeight' value='#= NetWeight #' />" +
                             "<input type='hidden' name='Details[#= index(data)#].PackingTypeId' value='#= PackingTypeId #' />" +
                             "<input type='hidden' name='Details[#= index(data)#].PackingTypeName' value='#= PackingTypeName #' />" +
                             "<input type='hidden' name='Details[#= index(data)#].Quantity' value='#= Quantity #' />"
                         )
                         .HtmlAttributes(new { style = "text-align: right" })
                         .HeaderHtmlAttributes(new { @class = "k-text-center !k-justify-content-center" });

                    columns.Bound(m => m.Barcode)
                         .ClientTemplate("#= Barcode #" + "<input type='hidden' name='Details[#= index(data)#].Barcode' value='#= Barcode #' />")
                         .HtmlAttributes(new { style = "text-align: left" })
                         .HeaderHtmlAttributes(new { @class = "k-text-center !k-justify-content-center" });
                 })
                 .Sortable()
                 .Scrollable()
                 .DataSource(dataSource => dataSource
                     .Ajax()
                     .ServerOperation(false)
                     .Aggregates(aggregates => { aggregates.Add(m => m.Mrp).Sum(); })
                     .Events(e => e.Error("onError")))
                 .Resizable(resize => resize.Columns(true))
                 .Reorderable(reorder => reorder.Columns(true)))
    </div>
</div>

<script type="text/javascript">
    $("#Barcode").on("keypress", function (e) {
        if (e.which === 13) { // Enter key pressed
            e.preventDefault();

            var barcode = $(this).val();

            if (true === ValidateBarcodes(barcode)) {
                $.ajax({
                    url: '/DemoProject/SalesInvoice/ValidateBarcode',
                    type: 'GET',
                    dataType: 'json',
                    data: { barcode: barcode },
                    success: function (response) {
                        console.log("Data received:", response);
                        if (response.Success) {
                            var detail =
                                response.Detail ||
                                response.SalesInvoiceDetailDto ||
                                response.Data ||
                                {
                                    Barcode: response.Barcode,
                                    ProductId: response.ProductId,
                                    ProductName: response.ProductName,
                                    PackingTypeId: response.PackingTypeId,
                                    PackingTypeName: response.PackingTypeName,
                                    Quantity: response.Quantity,
                                    Mrp: response.Mrp,
                                    NetWeight: response.NetWeight
                                };

                            AddNewRowInGrid(detail);

                            $('#Barcode').val('').focus();
                        } else {
                            ShowError(response.Message);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.log("xhr : " + xhr + ", status : " + status + ", error : " + error);
                        console.log("Error fetching data: " + xhr.status + " - " + xhr.statusText);
                        alert("Error fetching data : " + xhr.status + ", text : " + xhr.responseText);
                    }
                });
            }
        }
    });

    function ShowError(message) {
        bootbox.alert({
            title: "Error",
            message: message,
            centerVertical: true,
        });
    };

    function ValidateBarcodes(barcode) {
        if (!barcode) {
            ShowError("Please, Scan customer barcode");
            return false;
        }
        return true;
    }

    function IsBarcodeAvailableInGrid(grid, barcode) {
        var existingRecords = grid.dataSource.data();
        var barcodeExists = existingRecords.some(function (record) {
            return record.Barcode === barcode;
        });

        return barcodeExists;
    }

    function AddNewRowInGrid(detailDto) {
        var grid = $("#grid").data("kendoGrid");
        if (!detailDto) {
            ShowError("Invalid product detail received.");
            return;
        }

        if (IsBarcodeAvailableInGrid(grid, detailDto.Barcode) === true) {
            ShowError("Barcode already scanned");
            return;
        }

        grid.dataSource.add({
            ProductId: detailDto.ProductId,
            ProductName: detailDto.ProductName,
            PackingTypeId: detailDto.PackingTypeId,
            PackingTypeName: detailDto.PackingTypeName,
            Barcode: detailDto.Barcode,
            Quantity: detailDto.Quantity,
            Mrp: detailDto.Mrp,
            NetWeight: detailDto.NetWeight
        });

        grid.dataSource.sync();
    }

    function onError(e) {
        if (e.errors) {
            var message = "Errors:\n";
            $.each(e.errors, function (key, value) {
                if (value.errors) {
                    message += value.errors.join("\n");
                }
            });
            alert(message);
        }
    }
</script>